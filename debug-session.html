<!DOCTYPE html>
<html>
<head>
  <title>è°ƒè¯•ä¼šè¯åŠŸèƒ½</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .info { background: #e3f2fd; padding: 15px; margin: 10px 0; border-radius: 5px; }
    .session-info { background: #2d3748; color: white; padding: 15px; margin: 20px 0; border-radius: 5px; font-family: monospace; }
    .storage-item { background: #f8f9fa; padding: 10px; margin: 5px 0; border-left: 4px solid #6c5ce7; }
    button { padding: 10px 20px; margin: 5px; background: #6c5ce7; color: white; border: none; border-radius: 5px; cursor: pointer; }
  </style>
</head>
<body>
  <h1>ğŸ” Excalidraw ä¼šè¯åŠŸèƒ½è°ƒè¯•</h1>
  
  <div id="session-info" class="session-info"></div>
  
  <button onclick="testStorage()">æµ‹è¯•å­˜å‚¨åŠŸèƒ½</button>
  <button onclick="showAllStorage()">æ˜¾ç¤ºæ‰€æœ‰å­˜å‚¨</button>
  <button onclick="clearStorage()">æ¸…é™¤å½“å‰ä¼šè¯å­˜å‚¨</button>
  
  <div id="output"></div>
  
  <script>
    // æ¨¡æ‹Ÿ getSessionStorageKey å‡½æ•°
    function getSessionStorageKey(baseKey) {
      const urlParams = new URLSearchParams(window.location.search);
      const sessionId = urlParams.get("session");
      
      if (!sessionId || sessionId === "default") {
        return baseKey; // å‘åå…¼å®¹é»˜è®¤ä¼šè¯
      }
      
      return `${baseKey}:${sessionId}`;
    }
    
    // æ˜¾ç¤ºå½“å‰ä¼šè¯ä¿¡æ¯
    function showSessionInfo() {
      const urlParams = new URLSearchParams(window.location.search);
      const sessionId = urlParams.get("session") || "default";
      
      document.getElementById('session-info').innerHTML = `
        <strong>å½“å‰ä¼šè¯:</strong> ${sessionId}<br>
        <strong>URL:</strong> ${window.location.href}<br>
        <strong>æµ‹è¯•å­˜å‚¨é”®:</strong> ${getSessionStorageKey('excalidraw')}
      `;
    }
    
    // æµ‹è¯•å­˜å‚¨åŠŸèƒ½
    function testStorage() {
      const testData = {
        timestamp: Date.now(),
        session: new URLSearchParams(window.location.search).get("session") || "default",
        testMessage: `æ¥è‡ª ${new URLSearchParams(window.location.search).get("session") || "default"} ä¼šè¯çš„æµ‹è¯•æ•°æ®`
      };
      
      const storageKey = getSessionStorageKey('excalidraw');
      localStorage.setItem(storageKey, JSON.stringify(testData));
      
      showOutput(`âœ… å·²ä¿å­˜æµ‹è¯•æ•°æ®åˆ°: ${storageKey}`);
      showAllStorage();
    }
    
    // æ˜¾ç¤ºæ‰€æœ‰ç›¸å…³å­˜å‚¨
    function showAllStorage() {
      const output = document.getElementById('output');
      let html = '<h3>ğŸ“¦ LocalStorage å†…å®¹:</h3>';
      
      // æ˜¾ç¤ºæ‰€æœ‰ excalidraw ç›¸å…³çš„é”®
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && key.includes('excalidraw')) {
          const value = localStorage.getItem(key);
          let displayValue = value;
          
          try {
            const parsed = JSON.parse(value);
            displayValue = JSON.stringify(parsed, null, 2);
          } catch (e) {
            // ä¿æŒåŸå§‹å€¼
          }
          
          html += `
            <div class="storage-item">
              <strong>é”®:</strong> ${key}<br>
              <strong>å€¼:</strong> <pre style="white-space: pre-wrap; font-size: 12px;">${displayValue.substring(0, 200)}${displayValue.length > 200 ? '...' : ''}</pre>
            </div>
          `;
        }
      }
      
      output.innerHTML = html;
    }
    
    // æ¸…é™¤å½“å‰ä¼šè¯å­˜å‚¨
    function clearStorage() {
      const sessionId = new URLSearchParams(window.location.search).get("session") || "default";
      const keysToRemove = [];
      
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && key.includes('excalidraw')) {
          if (sessionId === "default" && !key.includes(':')) {
            keysToRemove.push(key);
          } else if (sessionId !== "default" && key.includes(`:${sessionId}`)) {
            keysToRemove.push(key);
          }
        }
      }
      
      keysToRemove.forEach(key => localStorage.removeItem(key));
      showOutput(`ğŸ—‘ï¸ å·²æ¸…é™¤ ${keysToRemove.length} ä¸ªå­˜å‚¨é¡¹`);
      showAllStorage();
    }
    
    function showOutput(message) {
      const timestamp = new Date().toLocaleTimeString();
      console.log(`[${timestamp}] ${message}`);
    }
    
    // é¡µé¢åŠ è½½æ—¶æ‰§è¡Œ
    showSessionInfo();
    showAllStorage();
  </script>
</body>
</html>