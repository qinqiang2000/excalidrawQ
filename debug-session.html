<!DOCTYPE html>
<html>
<head>
  <title>调试会话功能</title>
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; }
    .info { background: #e3f2fd; padding: 15px; margin: 10px 0; border-radius: 5px; }
    .session-info { background: #2d3748; color: white; padding: 15px; margin: 20px 0; border-radius: 5px; font-family: monospace; }
    .storage-item { background: #f8f9fa; padding: 10px; margin: 5px 0; border-left: 4px solid #6c5ce7; }
    button { padding: 10px 20px; margin: 5px; background: #6c5ce7; color: white; border: none; border-radius: 5px; cursor: pointer; }
  </style>
</head>
<body>
  <h1>🔍 Excalidraw 会话功能调试</h1>
  
  <div id="session-info" class="session-info"></div>
  
  <button onclick="testStorage()">测试存储功能</button>
  <button onclick="showAllStorage()">显示所有存储</button>
  <button onclick="clearStorage()">清除当前会话存储</button>
  
  <div id="output"></div>
  
  <script>
    // 模拟 getSessionStorageKey 函数
    function getSessionStorageKey(baseKey) {
      const urlParams = new URLSearchParams(window.location.search);
      const sessionId = urlParams.get("session");
      
      if (!sessionId || sessionId === "default") {
        return baseKey; // 向后兼容默认会话
      }
      
      return `${baseKey}:${sessionId}`;
    }
    
    // 显示当前会话信息
    function showSessionInfo() {
      const urlParams = new URLSearchParams(window.location.search);
      const sessionId = urlParams.get("session") || "default";
      
      document.getElementById('session-info').innerHTML = `
        <strong>当前会话:</strong> ${sessionId}<br>
        <strong>URL:</strong> ${window.location.href}<br>
        <strong>测试存储键:</strong> ${getSessionStorageKey('excalidraw')}
      `;
    }
    
    // 测试存储功能
    function testStorage() {
      const testData = {
        timestamp: Date.now(),
        session: new URLSearchParams(window.location.search).get("session") || "default",
        testMessage: `来自 ${new URLSearchParams(window.location.search).get("session") || "default"} 会话的测试数据`
      };
      
      const storageKey = getSessionStorageKey('excalidraw');
      localStorage.setItem(storageKey, JSON.stringify(testData));
      
      showOutput(`✅ 已保存测试数据到: ${storageKey}`);
      showAllStorage();
    }
    
    // 显示所有相关存储
    function showAllStorage() {
      const output = document.getElementById('output');
      let html = '<h3>📦 LocalStorage 内容:</h3>';
      
      // 显示所有 excalidraw 相关的键
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && key.includes('excalidraw')) {
          const value = localStorage.getItem(key);
          let displayValue = value;
          
          try {
            const parsed = JSON.parse(value);
            displayValue = JSON.stringify(parsed, null, 2);
          } catch (e) {
            // 保持原始值
          }
          
          html += `
            <div class="storage-item">
              <strong>键:</strong> ${key}<br>
              <strong>值:</strong> <pre style="white-space: pre-wrap; font-size: 12px;">${displayValue.substring(0, 200)}${displayValue.length > 200 ? '...' : ''}</pre>
            </div>
          `;
        }
      }
      
      output.innerHTML = html;
    }
    
    // 清除当前会话存储
    function clearStorage() {
      const sessionId = new URLSearchParams(window.location.search).get("session") || "default";
      const keysToRemove = [];
      
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && key.includes('excalidraw')) {
          if (sessionId === "default" && !key.includes(':')) {
            keysToRemove.push(key);
          } else if (sessionId !== "default" && key.includes(`:${sessionId}`)) {
            keysToRemove.push(key);
          }
        }
      }
      
      keysToRemove.forEach(key => localStorage.removeItem(key));
      showOutput(`🗑️ 已清除 ${keysToRemove.length} 个存储项`);
      showAllStorage();
    }
    
    function showOutput(message) {
      const timestamp = new Date().toLocaleTimeString();
      console.log(`[${timestamp}] ${message}`);
    }
    
    // 页面加载时执行
    showSessionInfo();
    showAllStorage();
  </script>
</body>
</html>